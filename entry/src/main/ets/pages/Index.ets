import router from '@ohos.router';
import { DataService } from '../utils/DataService';
import { Product } from '../models/Models';

@Entry
@Component
struct Index {
  @State selectedTab: number = 0;
  private categories: string[] = DataService.getCategories();

  build() {
    Column() {
      // é¡¶éƒ¨æœç´¢æ 
      Row() {
        Text('é¸¿è’™å•†åŸŽ')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor('#FF6600')
        
        Blank()
        
        Text('ðŸ›’ ' + DataService.getCartItemCount())
          .fontSize(18)
          .onClick(() => {
            router.pushUrl({ url: 'pages/Cart' });
          })
      }
      .width('100%')
      .height(60)
      .padding({ left: 20, right: 20 })
      .backgroundColor('#FFFFFF')

      // æœç´¢æ¡†
      Row() {
        TextInput({ placeholder: 'æœç´¢å•†å“' })
          .width('100%')
          .height(40)
          .backgroundColor('#F5F5F5')
          .borderRadius(20)
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 10, bottom: 10 })
      .backgroundColor('#FFFFFF')

      Tabs({ barPosition: BarPosition.End }) {
        // é¦–é¡µ
        TabContent() {
          this.HomeContent()
        }
        .tabBar(this.TabBuilder(0, 'é¦–é¡µ', 'ðŸ '))

        // åˆ†ç±»
        TabContent() {
          this.CategoryContent()
        }
        .tabBar(this.TabBuilder(1, 'åˆ†ç±»', 'ðŸ“‹'))

        // è´­ç‰©è½¦
        TabContent() {
          this.CartTab()
        }
        .tabBar(this.TabBuilder(2, 'è´­ç‰©è½¦', 'ðŸ›’'))

        // æˆ‘çš„
        TabContent() {
          this.ProfileTab()
        }
        .tabBar(this.TabBuilder(3, 'æˆ‘çš„', 'ðŸ‘¤'))
      }
      .width('100%')
      .height('100%')
      .barMode(BarMode.Fixed)
      .onChange((index: number) => {
        this.selectedTab = index;
      })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  @Builder TabBuilder(index: number, name: string, icon: string) {
    Column() {
      Text(icon)
        .fontSize(24)
      Text(name)
        .fontSize(12)
        .fontColor(this.selectedTab === index ? '#FF6600' : '#999999')
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }

  @Builder HomeContent() {
    Scroll() {
      Column() {
        // è½®æ’­å›¾åŒºåŸŸ
        Text('ðŸŽ‰ æ¬¢è¿Žæ¥åˆ°é¸¿è’™å•†åŸŽ')
          .width('90%')
          .height(150)
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .textAlign(TextAlign.Center)
          .backgroundColor('#FF6600')
          .fontColor('#FFFFFF')
          .borderRadius(10)
          .margin({ top: 10, bottom: 10 })

        // å•†å“åˆ†ç±»å¿«æ·å…¥å£
        Text('å•†å“åˆ†ç±»')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .margin({ top: 10, bottom: 10 })
          .alignSelf(ItemAlign.Start)
          .margin({ left: 20 })

        Grid() {
          ForEach(this.categories, (category: string) => {
            GridItem() {
              Column() {
                Text('ðŸ“¦')
                  .fontSize(40)
                Text(category)
                  .fontSize(14)
                  .margin({ top: 5 })
              }
              .width('100%')
              .height(100)
              .backgroundColor('#FFFFFF')
              .borderRadius(10)
              .justifyContent(FlexAlign.Center)
              .onClick(() => {
                router.pushUrl({
                  url: 'pages/ProductList',
                  params: { category: category }
                });
              })
            }
          })
        }
        .columnsTemplate('1fr 1fr 1fr')
        .rowsGap(10)
        .columnsGap(10)
        .width('90%')
        .height(220)

        // æŽ¨èå•†å“
        Text('æŽ¨èå•†å“')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .margin({ top: 20, bottom: 10 })
          .alignSelf(ItemAlign.Start)
          .margin({ left: 20 })

        this.ProductGrid(DataService.getAllProducts())
      }
      .width('100%')
    }
    .width('100%')
    .height('100%')
  }

  @Builder CategoryContent() {
    Column() {
      List() {
        ForEach(this.categories, (category: string) => {
          ListItem() {
            Row() {
              Text('ðŸ“¦')
                .fontSize(30)
                .margin({ right: 15 })
              Text(category)
                .fontSize(16)
              Blank()
              Text('â†’')
                .fontSize(20)
            }
            .width('100%')
            .height(60)
            .padding({ left: 20, right: 20 })
            .backgroundColor('#FFFFFF')
            .onClick(() => {
              router.pushUrl({
                url: 'pages/ProductList',
                params: { category: category }
              });
            })
          }
          .margin({ bottom: 10 })
        })
      }
      .width('100%')
      .height('100%')
    }
    .width('100%')
    .height('100%')
    .padding({ top: 10 })
  }

  @Builder CartTab() {
    Column() {
      Button('æŸ¥çœ‹è´­ç‰©è½¦è¯¦æƒ…')
        .width('80%')
        .height(50)
        .fontSize(16)
        .backgroundColor('#FF6600')
        .borderRadius(25)
        .margin({ top: 50 })
        .onClick(() => {
          router.pushUrl({ url: 'pages/Cart' });
        })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }

  @Builder ProfileTab() {
    Column() {
      Button('æŸ¥çœ‹ä¸ªäººä¸­å¿ƒ')
        .width('80%')
        .height(50)
        .fontSize(16)
        .backgroundColor('#FF6600')
        .borderRadius(25)
        .margin({ top: 50 })
        .onClick(() => {
          router.pushUrl({ url: 'pages/Profile' });
        })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }

  @Builder ProductGrid(products: Product[]) {
    Grid() {
      ForEach(products, (product: Product) => {
        GridItem() {
          Column() {
            Text('ðŸ“·')
              .fontSize(60)
              .margin({ top: 20 })
            
            Text(product.name)
              .fontSize(14)
              .maxLines(2)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .margin({ top: 10, left: 10, right: 10 })
            
            Text('Â¥' + product.price)
              .fontSize(16)
              .fontColor('#FF6600')
              .fontWeight(FontWeight.Bold)
              .margin({ top: 5, bottom: 10 })
          }
          .width('100%')
          .height(200)
          .backgroundColor('#FFFFFF')
          .borderRadius(10)
          .onClick(() => {
            router.pushUrl({
              url: 'pages/ProductDetail',
              params: { productId: product.id }
            });
          })
        }
      })
    }
    .columnsTemplate('1fr 1fr')
    .rowsGap(10)
    .columnsGap(10)
    .width('90%')
    .margin({ bottom: 20 })
  }
}
